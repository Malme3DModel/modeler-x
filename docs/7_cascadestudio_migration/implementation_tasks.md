# 【次フェーズ作業指示書】バッチエクスポート機能実装

## 🛑 作業開始前の注意
- **必ず作業前に、下記の計画書を先に確認してください。**
  - `feature_comparison.md`（機能比較・現状把握）
  - `migration_plan.md`（プロジェクト全体像・設計方針・コード例）
  - `README.md`（全体スケジュール・作業手順）
- これらを把握した上で、実装タスクに着手してください。

## 🎯 目的・背景
- 複数のCADモデルやシーンを一括でエクスポートできる「バッチエクスポート機能」を追加し、ユーザーの作業効率を大幅に向上させる。
- 現状は単一ファイルのエクスポートのみ対応。今後の業務用途や大量データ処理に備え、バッチ処理・進行状況表示・エラー管理を実装する。

## 📝 具体的な作業手順
1. `hooks/useBatchExport.ts` を新規作成し、バッチエクスポート用のカスタムフックを実装する。
   - 複数ファイルのエクスポート要求を受け取り、順次または並列でワーカーにエクスポート処理を依頼する。
   - 進行状況（何件中何件完了）やエラー発生時のリカバリーを管理する。
2. UI側（例: `FileIOControls.tsx`や`ExportMenu.tsx`）からバッチエクスポートを呼び出せるようにする。
   - 複数ファイル選択UIや一括エクスポートボタンを追加。
   - 進行状況インジケーターや完了通知を表示。
3. 必要に応じて`public/workers/cadWorker.js`のエクスポート処理を拡張し、複数リクエストの同時処理やエラー時の安定動作を保証する。

## 💡 実装例・設計方針
- `useBatchExport`は以下のようなAPIを想定：
```typescript
const { startBatchExport, progress, results, errors, isExporting } = useBatchExport();

// 使用例
startBatchExport([{ fileName, format, settings }, ...]);
```
- 進行状況は`progress`（0〜100%）、`results`（成功ファイルリスト）、`errors`（失敗詳細）で管理。
- UIは既存の`ProgressIndicator`等を流用し、ユーザーに分かりやすく表示。
- エクスポート失敗時はリトライやスキップも検討。

## ✅ 完了基準
- 複数ファイルの一括エクスポートがUIから実行できる
- 進行状況・エラーがリアルタイムで表示される
- すべてのファイルが正常にダウンロードできる（または失敗時に明確なエラー通知）
- 主要なユースケースでE2Eテストがパスする

## ⚠️ 注意事項
- 既存の単一エクスポート機能との互換性を維持すること
- 大量ファイル時のパフォーマンス・UI応答性に注意
- ワーカー側の同時実行数やエラー時のリカバリー設計を明確に
- 進捗・エラー情報はユーザーに分かりやすく表示

---

## フェーズ4: ファイルI/O完全実装（進行中・残りタスク）

#### 📦 マイルストーン 4.3: エクスポート品質設定の完全実装

##### タスク4.3.1: ExportSettings統合
- **ファイル**: `components/cad/ExportSettings.tsx` (改良)
- **状態**: ⏳ 未着手
- **実装内容**:
  - ExportMenuとBatchExportDialogへの完全統合
  - プレビュー機能の追加
  - 品質設定のリアルタイム反映

##### タスク4.3.2: OBJエクスポート実装
- **ファイル**: `public/workers/cadWorker.js` (改良)
- **状態**: ⏳ 未着手
- **実装内容**:
  - OpenCascadeメッシュからOBJ形式への変換
  - 法線情報の出力
  - マテリアル情報の基本対応

#### 📦 マイルストーン 4.4: STEP/IGESファイル処理改善

##### タスク4.4.1: エラーハンドリング強化
- **ファイル**: `public/workers/cadWorker.js` (改良)
- **状態**: ⏳ 未着手
- **実装内容**:
  - ファイル検証の強化
  - 詳細なエラーメッセージ
  - 部分的な読み込み成功の対応

##### タスク4.4.2: ファイルプレビュー機能
- **ファイル**: `components/cad/FilePreview.tsx` (新規作成)
- **状態**: ⏳ 未着手
- **実装内容**:
  - インポート前のファイル情報表示
  - 形状プロパティの表示
  - サムネイル生成

### フェーズ5: PWA機能実装（未着手）
- Service Worker, PWAマニフェスト, インストールUI など

---