# CascadeStudio 完全移行計画 v2.0

## プロジェクト概要

本アプリは、元のCascadeStudioを**Next.js 14 + TypeScript + React Three Fiber**で再現するプロジェクトです。2024年12月時点での実装状況を詳細に調査し、元の機能と比較して不足している機能を特定し、完全移行のための最新計画を策定しました。

## 現在の実装状況（2024年12月時点）

### ✅ 完全実装済み機能

#### 1. 基本アーキテクチャ
- **Next.js 14 + TypeScript**: App Routerベースで実装完了
- **Golden Layout**: ドッキング可能ウィンドウシステム実装済み
- **React Three Fiber**: 3Dビューポート基盤完了
- **WebWorker**: CAD演算用ワーカー実装済み

#### 2. エディター機能
- **Monaco Editor**: `@monaco-editor/react`でモダン実装完了
- **TypeScript intellisense**: 正常動作確認済み
- **コード評価機能**: CADワーカーとの連携完了
- **シンタックスハイライト**: TypeScript対応完了

#### 3. GUI機能
- **Tweakpane統合**: 動的GUI生成システム実装済み
- **スライダー/チェックボックス**: 各種コントロール実装済み
- **GUI状態管理**: URLハッシュ対応完了

#### 4. CAD機能（基本）
- **OpenCascade.js v1.1.1**: 読み込み・初期化完了
- **基本形状レンダリング**: メッシュ生成・表示完了
- **CADワーカー通信**: メッセージング完了

#### 5. 3Dビューポート機能
- **レイキャスティング**: フェイス/エッジ検出完全実装
- **ホバーハイライト**: マウスオーバー時の視覚的フィードバック完了
- **ツールチップ表示**: オブジェクト情報表示完了
- **MatCapマテリアル**: 元と同等の見た目再現完了
- **ライティング設定**: 環境光・半球光・平行光源実装完了
- **フォグ機能**: 動的距離計算実装完了
- **エッジ表示**: LineSegmentsベース描画完了

#### 6. 状態管理
- **URLハッシュ保存**: プロジェクト状態の永続化完了
- **プロジェクト管理**: 保存/読み込み機能実装済み

### 🔄 部分実装済み機能

#### 1. ファイルI/O機能
- **STEPファイル**: 基本的な読み込みは動作、エクスポートは要検証
- **メッシュエクスポート**: STL/OBJ基本機能あり、品質要改善

#### 2. CAD標準ライブラリ
- **基本関数**: Box、Sphere等の基本形状は動作
- **高度な機能**: Boolean演算等の詳細動作確認要

### ❌ 未実装機能

## 1. 3D操作機能（最重要）

### 1.1 トランスフォームハンドル（ギズモ）
**状態**: ❌ 未実装
**説明**: 3Dオブジェクトの移動、回転、スケール操作
**元の実装**: `CascadeViewHandles.js`
**必要なファイル**: 
- `components/threejs/TransformGizmo.tsx` (新規作成)
- `components/threejs/ObjectSelector.tsx` (新規作成)
- `components/threejs/TransformControlsUI.tsx` (新規作成)

### 1.2 オブジェクト選択機能
**状態**: ❌ 未実装
**説明**: クリックによる3Dオブジェクト選択とマルチセレクション
**必要な実装**:
- クリック検出システム
- 選択状態の可視化
- 複数選択対応

### 1.3 カメラコントロール高度機能
**状態**: 🔄 部分実装
**説明**: 視点プリセット、フィット機能、アニメーション
**現状**: 基本的なOrbitControlsは動作
**必要な実装**:
- Front/Back/Top/Bottom/Left/Right/Isoビュー
- Fit to Object機能
- スムーズなカメラアニメーション

## 2. UI/UX機能

### 2.1 キーボードショートカット
**状態**: ❌ 未実装
**説明**: F5でリフレッシュ、Ctrl+Sで保存など
**元の実装**: `CascadeMain.js`のキーイベント
**必要な実装**:
- グローバルキーボードハンドリング
- エディターとの統合
- ヘルプ表示機能

### 2.2 プログレス表示
**状態**: ❌ 未実装
**説明**: CAD演算の進行状況表示
**元の実装**: コンソール出力のみ
**必要な実装**:
- 視覚的プログレスバー
- 操作キャンセル機能
- 詳細進行状況表示

### 2.3 エラーハンドリング強化
**状態**: 🔄 部分実装
**説明**: 包括的なエラー処理と表示
**現状**: 基本的なエラー表示はあり
**必要な実装**:
- エディターでのエラー行ハイライト
- 詳細なエラー情報表示
- 復旧機能提案

## 3. ファイルI/O機能完全実装

### 3.1 STEP/IGESファイル処理
**状態**: 🔄 部分実装
**説明**: CADファイルの完全サポート
**現状**: 基本的な読み込みは動作
**必要な実装**:
- エラーハンドリング強化
- ファイル検証機能
- プロパティ情報表示

### 3.2 エクスポート機能改善
**状態**: 🔄 部分実装
**説明**: 高品質なファイル出力
**現状**: STL/OBJ基本出力は可能
**必要な実装**:
- エクスポート品質設定
- バッチエクスポート
- ファイル形式追加

## 4. PWA機能

### 4.1 Service Worker
**状態**: ❌ 未実装（Next.jsアプリ）
**説明**: オフライン対応とキャッシング
**元の実装**: `service-worker.js`（移植必要）
**必要な実装**:
- Next.js対応Service Worker
- オフラインキャッシュ戦略
- アップデート通知機能

### 4.2 PWAマニフェスト
**状態**: ❌ 未実装（Next.jsアプリ）
**説明**: インストール対応
**元の実装**: `manifest.webmanifest`（移植必要）
**必要な実装**:
- Next.js用マニフェスト設定
- アプリアイコン最適化
- インストール促進UI

## 実装計画とロードマップ

### フェーズ2: 3D操作機能実装（最優先）
**期間**: 3週間
**目標**: 元のCascadeStudioと同等の3D操作機能実現
**状態**: ❌ 未開始

#### 2.1 トランスフォームハンドル実装（1.5週間）
**期間**: 1.5週間
**優先度**: 🔴 最高

**タスク2.1.1: TransformControlsコンポーネント作成**
- **ファイル**: `components/threejs/TransformGizmo.tsx`
- **期間**: 3日
- **内容**:
  - `@react-three/drei`のTransformControls統合
  - 移動・回転・スケールモード実装
  - OrbitControlsとの競合解決

**タスク2.1.2: オブジェクト選択システム**
- **ファイル**: `components/threejs/ObjectSelector.tsx`
- **期間**: 2日
- **内容**:
  - クリック検出とレイキャスティング
  - 選択状態管理
  - マルチセレクション対応

**タスク2.1.3: UI統合**
- **ファイル**: `components/threejs/TransformControlsUI.tsx`
- **期間**: 2日
- **内容**:
  - モード切り替えUI
  - ローカル/ワールド空間切り替え
  - ギズモ表示制御

**タスク2.1.4: ThreeJSViewportへの統合**
- **ファイル**: `components/threejs/ThreeJSViewport.tsx`
- **期間**: 1日
- **内容**:
  - 既存コンポーネントとの統合
  - イベントハンドリング調整

#### 2.2 カメラコントロール高度機能（1週間）
**期間**: 1週間
**優先度**: 🔴 高

**タスク2.2.1: 視点プリセット機能**
- **ファイル**: `components/cad/CameraControls.tsx`（改良）
- **期間**: 3日
- **内容**:
  - 6方向 + ISO視点の実装
  - スムーズなアニメーション追加
  - UI改善

**タスク2.2.2: Fit to Object機能**
- **ファイル**: `hooks/useCameraAnimation.ts`（新規）
- **期間**: 2日
- **内容**:
  - バウンディングボックス計算
  - 自動カメラ位置調整
  - アニメーション実装

**タスク2.2.3: カメラ設定最適化**
- **ファイル**: `components/threejs/ThreeJSViewport.tsx`
- **期間**: 2日
- **内容**:
  - カメラパラメータ調整
  - 操作性改善
  - 元との操作感統一

#### 2.3 統合テスト実装（0.5週間）
**期間**: 0.5週間
**優先度**: 🔴 高

**タスク2.3.1: E2Eテスト作成**
- **ファイル**: `tests/transform-controls.spec.ts`（新規）
- **期間**: 2日
- **内容**:
  - トランスフォーム操作テスト
  - カメラ操作テスト
  - 統合機能テスト

### フェーズ3: UI/UX機能実装
**期間**: 2週間
**目標**: ユーザビリティを元と同等以上に向上
**状態**: ❌ 未開始

#### 3.1 キーボードショートカット（1週間）
**優先度**: 🟡 中

**タスク3.1.1: グローバルショートカット**
- **ファイル**: `hooks/useKeyboardShortcuts.ts`（新規）
- **期間**: 3日
- **内容**:
  - F5リフレッシュ
  - Ctrl+S保存
  - エディターとの統合

**タスク3.1.2: ヘルプシステム**
- **ファイル**: `components/ui/HelpModal.tsx`（新規）
- **期間**: 2日
- **内容**:
  - ショートカット一覧表示
  - 操作ガイド
  - ツールチップ強化

#### 3.2 プログレス・エラー表示（1週間）
**優先度**: 🟡 中

**タスク3.2.1: プログレスバー実装**
- **ファイル**: `components/ui/ProgressIndicator.tsx`（新規）
- **期間**: 3日
- **内容**:
  - CAD演算進行状況表示
  - キャンセル機能
  - 詳細情報表示

**タスク3.2.2: エラーハンドリング強化**
- **ファイル**: `components/layout/ErrorBoundary.tsx`（改良）
- **期間**: 2日
- **内容**:
  - エディターエラー行表示
  - 復旧提案機能
  - ログ出力改善

### フェーズ4: ファイルI/O完全実装
**期間**: 2週間
**目標**: CADファイル処理を完全に元と同等にする
**状態**: ❌ 未開始

#### 4.1 STEP/IGESファイル処理改善（1週間）
**優先度**: 🟡 中

**タスク4.1.1: ファイル読み込み強化**
- **ファイル**: `public/workers/cadWorker.js`（改良）
- **期間**: 4日
- **内容**:
  - エラーハンドリング改善
  - ファイル検証機能
  - プロパティ情報取得

**タスク4.1.2: UI改善**
- **ファイル**: `components/cad/FileIOControls.tsx`（新規）
- **期間**: 3日
- **内容**:
  - ファイル選択UI改善
  - プレビュー機能
  - バッチ処理対応

#### 4.2 エクスポート機能強化（1週間）
**優先度**: 🟡 中

**タスク4.2.1: 品質設定実装**
- **ファイル**: `components/cad/ExportSettings.tsx`（新規）
- **期間**: 4日
- **内容**:
  - 解像度・品質設定
  - フォーマット別最適化
  - プレビュー機能

**タスク4.2.2: バッチエクスポート**
- **ファイル**: `hooks/useBatchExport.ts`（新規）
- **期間**: 3日
- **内容**:
  - 複数ファイル一括出力
  - 進行状況表示
  - エラー処理

### フェーズ5: PWA機能実装
**期間**: 1週間
**目標**: オフライン対応とインストール機能
**優先度**: 🟢 低
**状態**: ❌ 未開始

#### 5.1 Service Worker実装（0.5週間）
**タスク5.1.1: Next.js用Service Worker**
- **ファイル**: `public/sw.js`（新規）
- **期間**: 2日
- **内容**:
  - Next.js対応キャッシュ戦略
  - オフライン機能
  - アップデート通知

#### 5.2 PWAマニフェスト（0.5週間）
**タスク5.2.1: マニフェスト設定**
- **ファイル**: `public/manifest.json`（新規）
- **期間**: 1日
- **内容**:
  - インストール対応
  - アイコン最適化

**タスク5.2.2: インストールUI**
- **ファイル**: `components/ui/InstallPrompt.tsx`（新規）
- **期間**: 2日
- **内容**:
  - インストール促進
  - ブラウザ対応チェック

## 技術的な注意事項

### 1. 現在の技術スタック（確認済み）
- **Next.js**: 14.2.5 (App Router)
- **React**: 18.3.1
- **TypeScript**: 5.8.3
- **Three.js**: 0.160.0
- **React Three Fiber**: 8.15.12
- **@react-three/drei**: 9.92.7
- **OpenCascade.js**: 1.1.1
- **Monaco Editor**: @monaco-editor/react 4.7.0

### 2. パフォーマンス最適化
- **メモリ管理**: React Three FiberのuseFrameを適切に使用
- **レンダリング最適化**: useMemoとuseCallbackによる最適化実装済み
- **WebWorker効率化**: CAD演算の非同期処理最適化

### 3. 型安全性
- **TypeScript strict mode**: 有効
- **OpenCascade.js型定義**: カスタム型定義で補完
- **エラーハンドリング**: 型安全なエラー処理実装

### 4. テスト戦略
- **E2Eテスト**: Playwright実装済み
- **コンポーネントテスト**: 新機能実装時に追加
- **OpenCascade.js対応**: 条件付きテスト実行で安定性確保

### 5. 既知の技術的制約
- **OpenCascade.js v1.1.1**: gp_Pntコンストラクタ問題は解決済み
- **SSR対応**: useIsClientフックで適切に処理済み
- **Golden Layout**: 既存実装で安定動作確認済み

## 完了判定基準

### フェーズ2完了条件
1. ✅ TransformControlsでオブジェクトの移動・回転・スケールが可能
2. ✅ クリックによるオブジェクト選択が正常動作
3. ✅ 6方向視点 + ISO視点の切り替えが動作
4. ✅ Fit to Object機能が動作
5. ✅ 全E2Eテストがパス
6. ✅ 元のCascadeStudioと同等の操作感を実現

### 全体完了条件
1. ✅ 元のCascadeStudioの全機能が100%動作
2. ✅ TypeScript型安全性が完全
3. ✅ パフォーマンスが元以上
4. ✅ PWA対応完了
5. ✅ 包括的なテストカバレッジ
6. ✅ ドキュメントの完全性

## 実装開始手順

### 1. フェーズ2開始準備
```bash
# 依存関係の確認
npm install @react-three/drei three @types/three

# テスト環境の準備
npm run test

# 開発サーバー起動
npm run dev
```

### 2. 最初のタスク
**タスク2.1.1: TransformControlsコンポーネント作成**から開始し、`components/threejs/TransformGizmo.tsx`を作成してください。

### 3. 進捗管理
各タスク完了時に本計画書の状態を更新し、実装状況を正確に保ってください。

## 総所要期間

**合計**: 8週間
- フェーズ2: 3週間（最重要）
- フェーズ3: 2週間
- フェーズ4: 2週間  
- フェーズ5: 1週間

## 成功のポイント

1. **フェーズ2を最優先で完了**させること
2. **各タスクで必ずテストを作成**すること
3. **元のCascadeStudioとの操作感を重視**すること
4. **TypeScript型安全性を維持**すること
5. **パフォーマンスを常に監視**すること

この計画に従って実装を進めることで、元のCascadeStudioを完全に超える、技術的に優れたCADアプリケーションが完成します。 