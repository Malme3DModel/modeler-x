# CascadeStudio 完全移行計画

## プロジェクト概要

本アプリは、元のCascadeStudioを**Next.js 14 + TypeScript + React Three Fiber**で再現するプロジェクトです。現在の実装状況を調査し、元の機能と比較して不足している機能を特定し、完全移行のための計画を策定しました。

## 現在の実装状況

### ✅ 実装済み機能

1. **基本アーキテクチャ**
   - Next.js 14 + TypeScript
   - Golden Layoutによるドッキング可能ウィンドウ
   - React Three Fiberベースの3Dビューポート
   - WebWorkerベースのCAD演算

2. **エディター機能**
   - Monaco Editorの統合
   - TypeScript intellisense
   - コード評価機能

3. **GUI機能**
   - TweakpaneによるGUI生成
   - 動的スライダー、チェックボックス
   - GUI状態管理

4. **CAD機能**
   - OpenCascade.jsワーカー
   - 基本的な形状レンダリング
   - メッシュ生成とエッジ描画

5. **状態管理**
   - URLハッシュによる状態保存
   - プロジェクトの保存/読み込み

6. **3Dインタラクション**
   - レイキャスティングによるオブジェクト検出
   - フェイス/エッジの基本ハイライト
   - コンソールでのインデックス表示

### ❌ 未実装機能

## 1. 3D ビューポート機能

### 1.1 ホバーハイライト機能改善
**説明**: マウスホバー時のフェイスやエッジの視覚的ハイライト表示
**元の実装**: `CascadeView.js` の `raycaster` 機能
**現在の状況**: 基本実装済み、視覚的UI改善が必要
**必要な実装**:
- ハイライト表示の視覚的改善
- ツールチップでのインデックス表示
- パフォーマンス最適化

### 1.2 トランスフォームハンドル（ギズモ）
**説明**: 3Dオブジェクトの移動、回転、スケール操作
**元の実装**: `CascadeViewHandles.js`
**必要な実装**:
- Three.js TransformControlsの統合
- 移動、回転、スケールギズモ
- オブジェクト選択と操作

### 1.3 マテリアル・シェーディング
**説明**: 元のMatCapマテリアルの再現
**元の実装**: `dullFrontLitMetal.png` MatCap
**必要な実装**:
- MatCapマテリアルの追加
- 適切なライティング設定
- シャドウ表示の改善

## 2. CADワーカー機能

### 2.1 完全なファイルI/O
**説明**: STEP、IGES、STL、OBJの完全サポート
**元の実装**: `CascadeStudioFileUtils.js`
**必要な実装**:
- ファイルインポート機能の完全実装
- エクスポート機能の改善
- 外部ファイル管理

### 2.2 標準ライブラリの完全移植
**説明**: 元のCAD関数ライブラリの完全移植
**元の実装**: `CascadeStudioStandardLibrary.js`
**必要な実装**:
- 全CAD関数の移植確認
- 型定義の完整
- テストケースの追加

## 3. UI・UX機能

### 3.1 キーボードショートカット
**説明**: F5でリフレッシュ、Ctrl+Sで保存など
**元の実装**: `CascadeMain.js` のキーイベント
**必要な実装**:
- グローバルキーボードショートカット
- エディターショートカット
- ヘルプ表示機能

### 3.2 プログレス表示
**説明**: CAD演算の進行状況表示
**元の実装**: コンソールへの進行状況出力
**必要な実装**:
- 視覚的プログレスバー
- 操作キャンセル機能
- 詳細な進行状況表示

### 3.3 エラーハンドリング
**説明**: 包括的なエラー処理と表示
**元の実装**: コンソールエラー表示とエディターハイライト
**必要な実装**:
- エラー詳細の表示
- エディターでのエラー行ハイライト
- 復旧機能

## 4. PWA機能

### 4.1 Service Worker
**説明**: オフライン対応とキャッシング
**元の実装**: `service-worker.js`
**必要な実装**:
- Service Workerの実装
- オフラインキャッシュ戦略
- アップデート通知

### 4.2 マニフェスト
**説明**: PWAマニフェストとインストール対応
**元の実装**: `manifest.webmanifest`
**必要な実装**:
- PWAマニフェストの作成
- アプリアイコンの追加
- インストール促進

## 実装優先度と計画

### フェーズ1: 基本3D機能の完成（優先度: 高）
**期間**: 2週間（一部実装済み）
**目標**: 3Dビューポートの基本機能を元と同等にする

1. **ホバーハイライト機能の完成**
   - ファイル: `components/threejs/ThreeJSViewport.tsx`
   - 既存レイキャスティング機能の拡張
   - 視覚的なハイライト表示の実装
   - ツールチップUIの追加

2. **マテリアル・ライティングの改善**
   - MatCapマテリアルの追加
   - 適切なシャドウ設定
   - 元と同等の見た目の実現

3. **エッジ表示の改善**
   - エッジの適切な描画
   - ハイライト機能の実装

### フェーズ2: 高度な3D機能（優先度: 中）
**期間**: 2週間
**目標**: トランスフォーム機能と高度な操作の実装

1. **トランスフォームハンドルの実装**
   - `@react-three/drei` TransformControlsの統合
   - 移動、回転、スケール操作
   - オブジェクト選択機能

2. **カメラコントロールの改善**
   - 元と同等のカメラ操作
   - 視点プリセット機能
   - アニメーション機能

### フェーズ3: CAD機能の完成（優先度: 高）
**期間**: 3週間
**目標**: CAD機能を元と完全に同等にする

1. **ファイルI/O機能の完全実装**
   - STEPファイルのインポート/エクスポート
   - IGESファイル対応
   - STL、OBJエクスポートの改善

2. **標準ライブラリの確認と補完**
   - 全CAD関数の動作確認
   - 不足機能の実装
   - パフォーマンス最適化

### フェーズ4: UI/UX機能（優先度: 中）
**期間**: 1週間
**目標**: 使い勝手を元と同等にする

1. **キーボードショートカットの実装**
   - F5リフレッシュ機能
   - Ctrl+S保存機能
   - その他のショートカット

2. **プログレス表示の改善**
   - 視覚的プログレスバー
   - 操作キャンセル機能

### フェーズ5: PWA機能（優先度: 低）
**期間**: 1週間
**目標**: オフライン対応とインストール機能

1. **Service Workerの実装**
   - オフラインキャッシュ
   - アップデート機能

2. **PWAマニフェスト**
   - インストール対応
   - アプリアイコン

## 技術的な注意事項

### 1. SSRとCSRの互換性
- **クライアントサイドチェック**: `useIsClient` フックを使用
- **コンポーネントのマウント状態管理**: useEffect内でのDOM操作
- **エラー処理**: SSRレンダリング時の動作確認

### 2. パフォーマンス最適化
- React Three FiberのuseFrameを適切に使用
- メモ化によるレンダリング最適化
- WebWorkerの効率的な利用

### 3. 型安全性
- 全ての機能でTypeScript型定義を完備
- OpenCascade.js型定義の改善
- エラーハンドリングの型安全性

### 4. テスト戦略
- 各フェーズで自動テスト（Playwright）の実装
- E2Eテストによる機能確認
- パフォーマンステスト

## 完成時の期待される機能

✅ **完全な元機能の再現**
- 元のCascadeStudioと同等の全機能
- モダンなReact/TypeScript実装
- 改善されたUX/UI

✅ **追加の改善点**
- モバイル対応の向上
- アクセシビリティの改善
- パフォーマンスの最適化

この計画により、元のCascadeStudioの全機能を完全に再現し、さらにモダンな技術スタックによる改善を実現します。 